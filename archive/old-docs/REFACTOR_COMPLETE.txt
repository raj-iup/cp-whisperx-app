================================================================================
FINALIZE STAGE REMOVAL - REFACTOR COMPLETE
November 14, 2025
================================================================================

ISSUE RESOLVED:
- Duplicate output directories created by finalize stage
- Valid: 15_mux/Jaane Tu Ya Jaane Na 2008/Jaane Tu Ya Jaane Na 2008_subtitled.mp4
- Invalid: Jaane_Tu_Ya_Jaane_Na/ (symlink only)

SOLUTION:
- Removed finalize stage entirely (stage 16)
- Mux stage (15) is now the final stage
- Single canonical output location in 15_mux/<movie_title>/

CHANGES MADE:

1. Pipeline Configuration (scripts/pipeline.py)
   ✅ Removed finalize from STAGES list
   ✅ Updated mux to point to None (final stage)
   ✅ Removed finalize from STAGE_SCRIPTS mapping
   ✅ Removed finalize from --stages CLI choices
   ✅ Removed special finalize handling code

2. Scripts Removed/Deprecated
   ✅ finalize-output.sh - DELETED
   ✅ finalize-output.ps1 - DELETED
   ✅ scripts/finalize_output.py - DEPRECATED (renamed to _deprecated_*)
   ✅ scripts/finalize.py - DEPRECATED (renamed to _deprecated_*)

3. Documentation Updated
   ✅ docs/ARCHITECTURE.md - Updated to 15 stages
   ✅ docs/technical/PIPELINE_REFACTOR_2025-11-14.md - Stage counts updated
   ✅ docs/technical/REFACTOR_QUICK_REF.md - Stage table updated
   ✅ README.md - Pipeline stages table updated (15 stages)
   ✅ docs/FINALIZE_STAGE_REMOVAL.md - New comprehensive doc

4. Mux Stage (scripts/mux.py)
   ✅ Removed "for finalize stage" comment
   ✅ Now creates final_output.mp4 symlink at job root

PIPELINE STRUCTURE:

Before (16 stages):
01-05: Audio/Video/Metadata
06: ASR
07: Song Bias Injection
08: Lyrics Detection
09: Bias Correction
10: Diarization
11: Glossary Builder
12: Second Pass Translation
13: Post-NER
14: Subtitle Generation
15: Mux
16: Finalize ❌ REMOVED

After (15 stages):
01-05: Audio/Video/Metadata
06: ASR
07: Song Bias Injection
08: Lyrics Detection
09: Bias Correction
10: Diarization
11: Glossary Builder
12: Second Pass Translation
13: Post-NER
14: Subtitle Generation
15: Mux ✅ FINAL STAGE

FINAL OUTPUT LOCATION:
out/<date>/<user>/<job-id>/15_mux/<movie_title>/<movie_title>_subtitled.mp4

With convenience symlink:
out/<date>/<user>/<job-id>/final_output.mp4 → 15_mux/<movie_title>/<movie_title>_subtitled.mp4

TESTING:
✅ Job 20251114-0004 verified
✅ Valid output exists in 15_mux/
✅ Duplicate directory removed
✅ Pipeline runs with 15 stages
✅ Documentation consistent

BENEFITS:
1. Single canonical output location
2. No duplicate directories
3. Simpler pipeline (15 vs 16 stages)
4. Faster execution (no extra file ops)
5. More intuitive (mux naturally produces final output)

BACKWARD COMPATIBILITY:
- Old jobs with 16 stages still work
- Finalize directories can be safely deleted
- Resume capability maintained

FILES MODIFIED:
- scripts/pipeline.py
- scripts/mux.py
- docs/ARCHITECTURE.md
- docs/technical/PIPELINE_REFACTOR_2025-11-14.md
- docs/technical/REFACTOR_QUICK_REF.md
- README.md

FILES CREATED:
- docs/FINALIZE_STAGE_REMOVAL.md (comprehensive documentation)
- REFACTOR_COMPLETE.txt (this summary)

FILES DEPRECATED:
- scripts/_deprecated_finalize_output.py
- scripts/_deprecated_finalize.py

FILES REMOVED:
- finalize-output.sh
- finalize-output.ps1

================================================================================
REFACTOR STATUS: ✅ COMPLETE
All bootstrap scripts, documentation, and pipeline code updated
================================================================================
