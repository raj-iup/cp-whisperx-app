# Configuration Guidelines for CP-WhisperX-App

## Overview

This document defines the standards for managing configuration parameters in `.env.pipeline`.

## Core Principles

### 1. **Parameter Hygiene**
- **Remove unused parameters immediately**: If a parameter is not referenced in code, delete it.
- **No speculative parameters**: Only add parameters that are actively used.
- **Regular audits**: Review configuration monthly to identify dead code.

### 2. **Documentation Standards**

Every parameter **MUST** include:

#### a) Purpose
```bash
# PURPOSE: What this parameter controls
# Example:
# Purpose: Maximum characters per subtitle line for readability
```

#### b) Valid Values
```bash
# VALUES: All acceptable values with meanings
# Example:
# Values: 20-60 (characters)
#   Recommended: 42 (industry standard)
#   Short: 30-35 (for complex languages)
#   Long: 45-50 (for simple text)
```

#### c) Default Value
```bash
# DEFAULT: What value is used if not specified
# Example:
# Default: 42
```

#### d) Impact/Dependencies
```bash
# IMPACT: What happens when you change this
# Example:
# Impact: Lower values = more subtitle breaks
#         Higher values = faster reading required
```

### 3. **Organization Structure**

Parameters are organized by **pipeline stage** in execution order:

```
1. GLOBAL CONFIGURATION
   ├── Job Identification
   ├── Paths
   ├── Logging
   ├── Device Settings
   └── Docker Settings

2. PIPELINE STAGE CONTROL
   └── Enable/disable flags (STEP_*)

3. STAGE-SPECIFIC CONFIGURATION
   ├── Stage 1: DEMUX
   ├── Stage 1.5: SOURCE SEPARATION
   ├── Stage 2: TMDB
   ├── Stage 4: BIAS
   ├── Stage 5: SILERO VAD
   ├── Stage 6: PYANNOTE VAD
   ├── Stage 7: WHISPERX ASR
   ├── Stage 7.5: HALLUCINATION REMOVAL
   ├── Stage 8: DIARIZATION
   ├── Stage 9: TRANSLATION
   ├── Stage 10: LYRICS DETECTION
   ├── Stage 11: NER
   ├── Stage 12: SUBTITLE GENERATION
   └── Stage 13: MUX
```

### 4. **Naming Conventions**

#### Pattern: `{STAGE}_{COMPONENT}_{PROPERTY}`

Examples:
```bash
# Good
WHISPER_MODEL=large-v3           # Stage + Component + Property
SILERO_THRESHOLD=0.5             # Stage + Property
SUBTITLE_MAX_LINE_LENGTH=42      # Stage + Action + Property

# Bad
THRESHOLD=0.5                    # Too generic
WHISPERMODELSIZE=large-v3        # No underscores
model_name=large-v3              # Wrong case
```

#### Special Prefixes

- `STEP_*`: Pipeline stage enable/disable flags
- `*_ENABLED`: Feature toggle flags
- `*_DEVICE`: Device assignment (cpu/mps/cuda)
- `*_PATH`: File/directory paths

### 5. **Value Type Standards**

#### Boolean
```bash
# Use: true/false (lowercase)
ENABLED=true
DEBUG=false

# NOT: True, TRUE, 1, yes, on
```

#### Numeric
```bash
# Integer: No decimals
MAX_SPEAKERS=15

# Float: Always include decimal
THRESHOLD=0.5
DURATION=30.0
```

#### Strings
```bash
# No quotes in .env file
MODEL=large-v3
PATH=/path/to/file

# Quotes only for multi-word values with spaces
TITLE=Movie Title Here
```

#### Lists
```bash
# Comma-separated, no spaces
ENTITY_TYPES=PERSON,ORG,GPE,LOC
LANGUAGES=hi,ta,te,gu

# OR newline-separated for long lists (use comments)
```

### 6. **Device Assignment Pattern**

All ML stages follow this pattern:

```bash
# Global device (set by prepare-job.sh)
DEVICE=mps

# Stage-specific override (inherits from DEVICE if not set)
WHISPERX_DEVICE=mps
SILERO_DEVICE=mps
PYANNOTE_DEVICE=mps

# Auto-fallback: If MPS/CUDA fails, stage automatically retries on CPU
```

### 7. **Auto-Generated Parameters**

Some parameters are set by `prepare-job.sh` and should not be manually edited:

```bash
# Auto-generated by prepare-job.sh - DO NOT EDIT
JOB_ID=                          # Format: job-YYYYMMDD-user-NNNN
IN_ROOT=                         # Set from --media argument
OUTPUT_ROOT=                     # Generated from job ID
LOG_ROOT=                        # Generated from job ID
TITLE=                           # Parsed from filename
YEAR=                            # Parsed from filename
DEVICE=                          # Auto-detected hardware
```

Mark these clearly in comments.

### 8. **Parameter Lifecycle**

#### Adding a New Parameter

1. **Define in `.env.pipeline`** with full documentation
2. **Add to `scripts/config_loader.py`** if special handling needed
3. **Use in stage script** with validation
4. **Add to this document** under appropriate stage
5. **Add example** in usage documentation

Example:
```bash
# ============================================================================
# NEW_FEATURE - Feature Description
# ============================================================================
# Purpose: Clear explanation of what this controls
# When: Conditions for using this feature
# Impact: What changes when you adjust this
# ============================================================================

# FEATURE_ENABLED: Enable new feature
#   Values: true | false
#   Default: false (opt-in for testing)
#   Impact: Increases processing time by ~10%
#   Requires: Additional dependency X
FEATURE_ENABLED=false

# FEATURE_THRESHOLD: Sensitivity level
#   Values: 0.0 - 1.0
#   Default: 0.5
#   Lower = more aggressive (may introduce errors)
#   Higher = more conservative (may miss cases)
FEATURE_THRESHOLD=0.5
```

#### Deprecating a Parameter

1. **Mark as deprecated** in comments
2. **Add migration instructions**
3. **Keep for 2 versions** (backwards compatibility)
4. **Log deprecation warning** in code
5. **Remove after 2 versions**

Example:
```bash
# DEPRECATED: OLD_PARAM_NAME
# Use NEW_PARAM_NAME instead
# This parameter will be removed in v3.2.0
# Migration: OLD_PARAM_NAME=X → NEW_PARAM_NAME=Y
OLD_PARAM_NAME=value
```

#### Removing a Parameter

1. **Verify no code references** (grep entire codebase)
2. **Check all Python scripts** in `scripts/` and `shared/`
3. **Check shell scripts** (`bootstrap.sh`, `prepare-job.sh`, `run-pipeline.sh`)
4. **Delete from `.env.pipeline`**
5. **Update this document**

Verification script:
```bash
# Check if parameter is used
PARAM="SOME_PARAM_NAME"
grep -r "$PARAM" scripts/ shared/ *.sh --exclude-dir=venv --exclude-dir=.git
```

## Parameter Audit Checklist

Run this monthly:

```bash
# 1. Generate usage report
python3 /tmp/audit_params.py

# 2. Review unused parameters
# Delete any with 0 references

# 3. Check for undocumented parameters
grep "^[A-Z_]*=" config/.env.pipeline | while read line; do
    param=$(echo $line | cut -d'=' -f1)
    # Check if previous line is a comment
    # If not, parameter is undocumented
done

# 4. Verify all STEP_* flags have corresponding stage scripts
grep "^STEP_" config/.env.pipeline | cut -d'=' -f1 | while read step; do
    stage=$(echo $step | sed 's/STEP_//' | tr '[:upper:]' '[:lower:]')
    # Check if stage script exists
    ls scripts/*${stage}* 2>/dev/null || echo "Missing: $step"
done

# 5. Check for duplicate parameters
cut -d'=' -f1 config/.env.pipeline | sort | uniq -d
```

## Common Mistakes to Avoid

### ❌ Don't Do This

```bash
# 1. Vague parameter names
THRESHOLD=0.5                    # Threshold for what?
ENABLED=true                     # What feature?

# 2. No documentation
MAX_SIZE=1024

# 3. Inconsistent naming
whisper_Model=large              # Wrong case
WHISPER-MODEL=large              # Wrong separator

# 4. Magic numbers
TIMEOUT=300                      # What unit? Seconds? Minutes?

# 5. Unused parameters
EXPERIMENTAL_FEATURE=true        # Not referenced in code

# 6. Duplicate configuration
DEVICE=mps                       # In global section
WHISPER_DEVICE=mps               # Same value, use inheritance
```

### ✅ Do This Instead

```bash
# 1. Descriptive names with context
WHISPER_BEAM_SEARCH_THRESHOLD=0.5

# 2. Comprehensive documentation
# MAX_SIZE: Maximum memory allocation for model
#   Values: Integer (MB)
#   Default: 1024
#   Impact: Higher = better performance, more RAM usage
MAX_SIZE=1024

# 3. Consistent naming
WHISPER_MODEL=large-v3

# 4. Clear units
TIMEOUT_SECONDS=300              # Explicit unit in name

# 5. Remove unused parameters immediately
# (Delete, don't comment out)

# 6. Use inheritance
DEVICE=mps                       # Global setting
# Stage-specific overrides only when needed
DIARIZATION_DEVICE=cpu           # Override only if different
```

## Testing Configuration Changes

Before committing configuration changes:

```bash
# 1. Validate syntax
python3 -c "
import os
env_file = 'config/.env.pipeline'
with open(env_file) as f:
    for i, line in enumerate(f, 1):
        line = line.strip()
        if line and not line.startswith('#') and '=' in line:
            key = line.split('=')[0]
            if not key.replace('_', '').isalnum():
                print(f'Invalid parameter name at line {i}: {key}')
"

# 2. Test with minimal job
./prepare-job.sh --media test.mp4 --workflow transcribe \
  --source-language hi --log-level DEBUG

# 3. Verify parameter is read
grep "NEW_PARAM" out/.../logs/pipeline.log

# 4. Test all affected workflows
./prepare-job.sh --workflow transcribe ...
./prepare-job.sh --workflow translate ...
./prepare-job.sh --workflow subtitle ...
```

## Version History

- **v3.0.0** (2025-11-25): Major cleanup, removed 48 unused parameters
- **v2.0.0** (2025-11-20): Added IndicTrans2 support
- **v1.0.0** (2025-10-01): Initial release

## Related Documentation

- [Pipeline Architecture](ARCHITECTURE.md)
- [Stage Documentation](stages/README.md)
- [API Reference](API.md)

---

**Last Updated:** 2025-11-25  
**Maintainer:** Development Team  
**Review Frequency:** Monthly
