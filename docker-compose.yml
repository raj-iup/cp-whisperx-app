services:
  demux:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-demux:cpu"
    container_name: cp_whisperx_demux
    volumes:
      - ./in:/app/in:ro

      - ./out:/app/out

      - ./config:/app/config:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app

  tmdb:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-tmdb:cpu"
    container_name: cp_whisperx_tmdb
    volumes:

      - ./out:/app/out

      - ./config:/app/config:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - demux

  silero-vad:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-silero-vad:cpu"
    container_name: cp_whisperx_silero_vad
    volumes:

      - ./out:/app/out

      - ./config:/app/config:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - pre-ner

  pre-ner:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-pre-ner:cpu"
    container_name: cp_whisperx_pre_ner
    volumes:

      - ./out:/app/out

      - ./LLM:/app/LLM
      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - tmdb

  asr:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-asr:cpu"
    container_name: cp_whisperx_asr
    volumes:
      - ./in:/app/in

      - ./out:/app/out

      - ./LLM:/app/LLM
      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    # If you need to force a specific platform on Apple Silicon, add 'platform: linux/amd64'
    # platform: linux/amd64
    mem_limit: 16g
    memswap_limit: 16g
    depends_on:
      - diarization

  diarization:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-diarization:cpu"
    container_name: cp_whisperx_diarization
    volumes:
      - ./in:/app/in

      - ./out:/app/out

      - ./LLM:/app/LLM
      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - pyannote-vad

  pyannote-vad:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-pyannote-vad:cpu"
    container_name: cp_whisperx_pyannote_vad
    volumes:
      - ./in:/app/in

      - ./out:/app/out

      - ./LLM:/app/LLM
      - ./config:/app/config:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - silero-vad
    # platform: linux/amd64

  subtitle-gen:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-subtitle-gen:cpu"
    container_name: cp_whisperx_subtitle_gen
    volumes:

      - ./out:/app/out

      - ./config:/app/config:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - post-ner

  post-ner:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-post-ner:cpu"
    container_name: cp_whisperx_post_ner
    volumes:

      - ./out:/app/out

      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - asr

  mux:
    image: "${DOCKERHUB_USER:-rajiup}/cp-whisperx-app-mux:cpu"
    container_name: cp_whisperx_mux
    volumes:
      - ./in:/app/in:ro

      - ./out:/app/out

      - ./config:/app/config:ro
      - ./shared:/app/shared:ro
    environment:
      - CONFIG_PATH=${CONFIG_PATH:-/app/config/.env}
      - PYTHONPATH=/app
    depends_on:
      - subtitle-gen

# Usage notes:
# 1) Build all images:
#    docker compose build
# 2) Run complete pipeline (via run_pipeline_arch.py):
#    python3 run_pipeline_arch.py -i in/movie.mp4 --infer-tmdb-from-filename
# 3) Or run individual services:
#    docker compose run --rm demux in/movie.mp4
#    docker compose run --rm asr out/Movie_Name
