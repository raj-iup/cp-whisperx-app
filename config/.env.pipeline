# cp-whisperx-app Pipeline Configuration
# All pipeline steps read from this file

# ============================================================
# INPUT / OUTPUT
# ============================================================
IN_ROOT=
JOB_ID=
USER_ID=1
OUTPUT_ROOT=./out
WORKFLOW_MODE=subtitle-gen

# ============================================================
# LOGGING
# ============================================================
LOG_ROOT=./logs
LOG_LEVEL=info
# Options: json, text
LOG_TO_CONSOLE=true
LOG_TO_FILE=true

# ============================================================
# DOCKER REGISTRY
# ============================================================
DOCKER_REGISTRY=rajiup
DOCKER_TAG=latest

# ============================================================
# SECRETS & METADATA
# ============================================================
SECRETS_PATH=./config/secrets.json
SPEAKER_MAP=
CANON_MAP=./canon_map.yaml

# ============================================================
# PIPELINE CONTROL
# ============================================================
# Enable/disable pipeline steps
STEP_DEMUX=true
STEP_VAD_SILERO=true
STEP_VAD_PYANNOTE=true
STEP_WHISPERX=true
STEP_DIARIZATION=true
STEP_TMDB_METADATA=true
STEP_SUBTITLE_GEN=true
STEP_MUX=true

# ============================================================
# [1] FFMPEG DEMUX SETTINGS
# ============================================================
AUDIO_SAMPLE_RATE=16000
AUDIO_CHANNELS=1
AUDIO_FORMAT=wav
AUDIO_CODEC=pcm_s16le

# ============================================================
# [2] TMDB METADATA SETTINGS
# ============================================================
TMDB_ENABLED=true
TMDB_LANGUAGE=en-US

# ============================================================
# [3] PRE-ASR NER SETTINGS
# ============================================================
PRE_NER_MODEL=en_core_web_trf
PRE_NER_CONFIDENCE_THRESHOLD=0.7
PRE_NER_ENTITY_TYPES=PERSON,ORG,GPE,LOC,FAC

# ============================================================
# [4] SILERO VAD SETTINGS
# Silero VAD: Fast, coarse voice activity detection (PyTorch)
# Device: Determined by job DEVICE parameter (cpu/mps/cuda)
#         Runs in Docker on cpu, Native on mps/cuda
# ============================================================
SILERO_THRESHOLD=0.5
SILERO_MIN_SPEECH_DURATION_MS=250
SILERO_MIN_SILENCE_DURATION_MS=100
SILERO_MERGE_GAP_SEC=0.35

# ============================================================
# [5] PYANNOTE VAD SETTINGS - *  PYANNOTE_DEVICE can be 'CPU', 'CUDA', 'MPS'
# ============================================================
PYANNOTE_ONSET=0.5
PYANNOTE_OFFSET=0.5
PYANNOTE_MIN_DURATION_ON=0.0
PYANNOTE_MIN_DURATION_OFF=0.0
PYANNOTE_DEVICE=MPS

# ============================================================
# [6] PYANNOTE DIARIZATION SETTINGS
# SPEAKER_MAP auto-generated from metadata/tmdb_data.json (cast names)
# ============================================================
DIARIZATION_MIN_SPEAKERS=1
DIARIZATION_MAX_SPEAKERS=20
SPEAKER_MAP=
DIARIZATION_MODEL=pyannote/speaker-diarization-3.1
DIARIZATION_METHOD=pyannote
DIARIZATION_DEVICE=MPS
DIARIZATION_AUTO_SPEAKER_MAPPING=true

# ============================================================
# [7] WHISPERX ASR SETTINGS
# WHISPER_INITIAL_PROMPT auto-loaded from prompts/ner_enhanced_prompt.txt
# Core parameters work with both whisper and whisperx
# ============================================================
WHISPER_MODEL=large-v3
WHISPER_COMPUTE_TYPE=int8
WHISPER_BATCH_SIZE=16
WHISPER_LANGUAGE=hi
TARGET_LANGUAGE=en
WHISPER_TASK=translate
WHISPER_INITIAL_PROMPT=

# Advanced Whisper parameters (faster-whisper/whisperx)
WHISPER_TEMPERATURE=0.0,0.2,0.4,0.6,0.8,1.0
WHISPER_BEAM_SIZE=5
WHISPER_BEST_OF=5
WHISPER_PATIENCE=1.0
WHISPER_LENGTH_PENALTY=1.0
WHISPER_NO_SPEECH_THRESHOLD=0.6
WHISPER_LOGPROB_THRESHOLD=-1.0
WHISPER_COMPRESSION_RATIO_THRESHOLD=2.4
WHISPER_CONDITION_ON_PREVIOUS_TEXT=true

# WhisperX specific parameters
WHISPERX_DEVICE=MPS
WHISPERX_ALIGN_EXTEND=2.0
WHISPERX_ALIGN_FROM_PREV=true
WHISPERX_ALIGN_MODEL=auto
WHISPERX_INTERPOLATE_METHOD=nearest

# ============================================================
# [8] POST-ASR NER SETTINGS
# ============================================================
POST_NER_MODEL=en_core_web_trf
POST_NER_ENTITY_CORRECTION=true
POST_NER_TMDB_MATCHING=true
POST_NER_CONFIDENCE_THRESHOLD=0.8
POST_NER_DEVICE=cpu

# ============================================================
# [9] SUBTITLE GENERATION SETTINGS
# ============================================================
SUBTITLE_FORMAT=srt
SUBTITLE_MAX_LINE_LENGTH=42
SUBTITLE_MAX_LINES=2
SUBTITLE_INCLUDE_SPEAKER_LABELS=true
SUBTITLE_SPEAKER_FORMAT=[{speaker}]
SUBTITLE_WORD_LEVEL_TIMESTAMPS=false
SUBTITLE_MAX_DURATION=7.0
SUBTITLE_MERGE_SHORT=true

# ============================================================
# [9b] HINGLISH GLOSSARY SETTINGS
# Context-aware terminology substitution for Hinglishâ†’English translation
# Improves consistency and cultural accuracy (+20-30% terminology accuracy)
# ============================================================
GLOSSARY_ENABLED=true
GLOSSARY_PATH=glossary/hinglish_master.tsv

# Glossary Selection Strategy:
#   first      - Use first option (fast, default)
#   context    - Analyze surrounding text for context-aware selection
#   character  - Use character speaking style profiles
#   regional   - Apply regional variants (Mumbai, Delhi, Punjab, etc.)
#   frequency  - Learn from previous selections (improves over time)
#   adaptive   - Intelligently combine all strategies (recommended for best quality)
#   ml         - ML-based selection (future, falls back to adaptive)
GLOSSARY_STRATEGY=adaptive

# Movie-specific prompt file (auto-detected by prepare-job)
FILM_PROMPT_PATH=

# Frequency learning data (created during processing)
FREQUENCY_DATA_PATH=glossary/learned/term_frequency.json

# ============================================================
# [10] FFMPEG MUX SETTINGS - output soft embed subtitle video output by default
# ============================================================
MUX_SUBTITLE_CODEC=mov_text
MUX_SUBTITLE_LANGUAGE=eng
MUX_SUBTITLE_TITLE=English
MUX_COPY_VIDEO=true
MUX_COPY_AUDIO=true
MUX_CONTAINER_FORMAT=mp4

# ============================================================
# ADVANCED SETTINGS
# ============================================================
# Chunking for large files (auto-enabled if needed)
ENABLE_CHUNKING=false
CHUNK_DURATION_MINUTES=30
CHUNK_OVERLAP_SECONDS=5


# ============================================================
# DOCKER RESOURCE LIMITS
# ============================================================
DOCKER_MEMORY_LIMIT=10g
DOCKER_CPU_LIMIT=4
DOCKER_SHM_SIZE=2g

# ============================================================
# [7b] SECOND PASS TRANSLATION SETTINGS
# Refines WhisperX translations with specialized translation models
# Significantly improves translation quality (+15-20% accuracy)
# Backend options: 'nllb' (best), 'opus-mt', 'mbart'
# ============================================================
SECOND_PASS_ENABLED=true
SECOND_PASS_BACKEND=nllb

# ============================================================
# [7c] LYRICS DETECTION SETTINGS
# Automatically detects song sequences for special subtitle styling
# Improves song translation quality (+20-25% for Bollywood content)
# ============================================================
LYRIC_DETECT_ENABLED=true
LYRIC_THRESHOLD=0.5
LYRIC_STYLE=lyric
LYRIC_MIN_DURATION=30.0

