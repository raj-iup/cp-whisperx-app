name: Update AI Model Routing

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if within frequency window'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  update-routing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Check for model updates
        id: check
        run: |
          python tools/update-model-routing.py --check-only
          echo "check_exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Apply updates
        id: update
        if: steps.check.outputs.check_exit_code == '0' || github.event.inputs.force == 'true'
        run: |
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            python tools/update-model-routing.py --force
          else
            python tools/update-model-routing.py
          fi
          echo "update_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --name-only
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && steps.update.outputs.update_exit_code == '0'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: auto-update AI model routing'
          committer: GitHub Actions <actions@github.com>
          author: GitHub Actions <actions@github.com>
          branch: auto-update-model-routing
          delete-branch: true
          title: 'Auto-update: AI Model Routing'
          body: |
            ## ðŸ¤– Automated Model Routing Update
            
            This PR updates AI model routing based on:
            - New model releases (if any)
            - Performance benchmarks
            - Cost optimizations
            - Weekly maintenance
            
            ### ðŸ“‹ Changes Made
            
            - âœ… Updated `docs/AI_MODEL_ROUTING.md`
            - âœ… Synced `.github/copilot-instructions.md`
            - âœ… Updated model registry timestamp
            
            ### ðŸ“Š Current Models
            
            See `config/ai_models.json` for complete registry.
            
            ### âœ… Review Checklist
            
            - [ ] Routing decisions are optimal for each task type
            - [ ] Cost trade-offs are acceptable
            - [ ] Documentation is clear and accurate
            - [ ] No breaking changes to existing workflows
            
            ### ðŸ”„ Workflow
            
            **Triggered by:** ${{ github.event_name }}
            **Run date:** ${{ github.event.repository.updated_at }}
            **Workflow:** `.github/workflows/update-model-routing.yml`
            
            ---
            
            **Note:** This PR was automatically generated by GitHub Actions.
            Review the changes and merge if they look correct.
          labels: |
            documentation
            automated
            ai-models
      
      - name: Summary
        if: always()
        run: |
          echo "### AI Model Routing Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.update.outputs.update_exit_code }}" == "0" ]; then
            echo "âœ… **Status:** Update successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Update failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "ðŸ“ **Changes:** Documentation updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Modified files:**" >> $GITHUB_STEP_SUMMARY
            git diff --name-only | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "â„¹ï¸ **Changes:** No updates needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next scheduled run:** Every Monday at 9 AM UTC" >> $GITHUB_STEP_SUMMARY
