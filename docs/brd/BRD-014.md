# Business Requirement Document

**Document ID:** BRD-014  
**Title:** Multi-Phase Subtitle Workflow for Quality & Performance  
**Version:** 1.0  
**Date:** 2025-12-08  
**Status:** üîÑ In Progress (Week 1 Complete)  
**Author:** System Architect

---

## 1. Executive Summary

Enable subtitle workflow to generate baseline outputs (ASR, alignment, glossary) once and reuse them across multiple iterations. This allows users to refine subtitles through translation adjustments, style improvements, or target language changes without re-running expensive ASR and alignment stages, achieving 70-80% time savings on subsequent runs.

---

## 2. Business Objectives

### 2.1 Problem Statement
- Current subtitle workflow re-runs ASR (5-15 min) and alignment (2-5 min) every time, even for minor translation tweaks
- Users iterate frequently on subtitle quality (glossary updates, translation refinements, style changes)
- Each full pipeline run takes 20-40 minutes, making iteration painful
- No mechanism to reuse previous high-quality ASR/alignment results

### 2.2 Goals
- **Primary:** Enable 70-80% faster subtitle iterations by reusing baseline
- **Secondary:** Maintain 100% quality (no degradation from caching)
- **Tertiary:** Transparent caching (users don't need to manage it)

### 2.3 Success Criteria
- ‚úÖ First run: Generates baseline (ASR, alignment, glossary) and stores in cache
- ‚úÖ Second run (same media): Reuses baseline, completes in 5-8 minutes (vs 20-40)
- ‚úÖ Quality identical to fresh ASR run
- ‚úÖ Cache automatically invalidates on significant changes (model version, media content)
- ‚úÖ Users can force fresh ASR with `--no-cache` flag

---

## 3. Stakeholders

| Role | Responsibility |
|------|----------------|
| Content Creators | Iterate on subtitle quality rapidly |
| Pipeline Developers | Implement caching system |
| QA Team | Validate quality with cached baseline |
| End Users | Benefit from faster iterations |

---

## 4. User Requirements

### 4.1 User Stories

**US-001:** As a **subtitle creator**, I want **to refine translations without re-running ASR** so that **I can iterate quickly on subtitle quality**.

**Acceptance Criteria:**
- [x] First run generates and caches baseline
- [x] Subsequent runs reuse baseline automatically
- [x] 70-80% time reduction on second run
- [x] Quality metrics unchanged

**US-002:** As a **content producer**, I want **to generate subtitles in multiple languages from same baseline** so that **I can efficiently create multilingual content**.

**Acceptance Criteria:**
- [ ] Generate English subtitles (uses baseline)
- [ ] Add Spanish subtitles (reuses same baseline)
- [ ] Add Arabic subtitles (reuses same baseline)
- [ ] All languages have identical timing/ASR quality

**US-003:** As a **user**, I want **caching to be automatic and transparent** so that **I don't need to manage cache files manually**.

**Acceptance Criteria:**
- [x] Cache location managed by system
- [x] Media ID computed automatically
- [x] Cache invalidation automatic
- [x] Optional `--no-cache` override

**US-004:** As a **developer**, I want **to force fresh ASR when needed** so that **I can debug or validate changes**.

**Acceptance Criteria:**
- [x] `--no-cache` flag forces fresh processing
- [x] `--clear-cache` removes cached data
- [x] Clear documentation of cache behavior

---

## 5. Functional Requirements

### FR-001: Media Identity Computation
**Priority:** Critical  
**Description:** Compute stable media_id from media file hash  
**Rationale:** Enable cache lookup and storage

**Status:** ‚úÖ Complete (Week 1)

### FR-002: Baseline Cache Storage
**Priority:** Critical  
**Description:** Store ASR results, alignment, segments, glossary in cache  
**Rationale:** Enable reuse across runs

**Status:** ‚úÖ Complete (Week 1)

### FR-003: Baseline Cache Retrieval
**Priority:** Critical  
**Description:** Check cache and load baseline if available  
**Rationale:** Enable fast iterations

**Status:** ‚úÖ Complete (Week 1)

### FR-004: Cache Invalidation
**Priority:** High  
**Description:** Invalidate cache on model version change or media modification  
**Rationale:** Maintain quality and correctness

**Status:** üîÑ In Progress

### FR-005: Workflow Integration
**Priority:** Critical  
**Description:** Integrate caching into run-pipeline.py  
**Rationale:** Make caching transparent to users

**Status:** ‚è≥ Planned (Week 1 Day 3-4)

### FR-006: Performance Testing
**Priority:** High  
**Description:** Validate 70-80% speedup with real media  
**Rationale:** Confirm user benefit

**Status:** ‚è≥ Planned (Performance Validation)

---

## 6. Non-Functional Requirements

### 6.1 Performance
- **First Run:** Baseline generation time (no overhead)
- **Second Run:** 70-80% faster (5-8 min vs 20-40 min)
- **Cache Lookup:** <1 second
- **Cache Storage:** <2 seconds

### 6.2 Quality
- **ASR Quality:** Identical to fresh run (‚â•95% WER)
- **Alignment Quality:** Identical to fresh run
- **Translation Quality:** Identical to fresh run (‚â•90% BLEU)
- **Subtitle Quality:** Identical to fresh run (‚â•88%)

### 6.3 Storage
- **Cache Size:** ~50-100 MB per movie (ASR + alignment data)
- **Cache Location:** `~/.cp-whisperx/cache/baselines/{media_id}/`
- **Cache Expiration:** Manual cleanup only (not automatic)

### 6.4 Usability
- **Transparency:** Users don't manage cache manually
- **Discoverability:** Log messages indicate cache hit/miss
- **Override:** `--no-cache` flag available

---

## 7. Constraints & Assumptions

### 7.1 Constraints
- **Storage:** Users must have sufficient disk space for cache
- **Compatibility:** Cache format may change between versions
- **Media Identity:** Relies on stable file hash (byte-identical media)

### 7.2 Assumptions
- Users iterate on same media multiple times
- Media files don't change between runs (same byte content)
- Cache directory is writable and persistent
- Users want faster iterations more than fresh ASR every time

---

## 8. Dependencies

- **AD-014:** Multi-phase subtitle workflow architecture
- **shared/media_identity.py:** Media ID computation (‚úÖ Complete)
- **shared/cache_manager.py:** Cache storage/retrieval (‚úÖ Complete)
- **run-pipeline.py:** Workflow orchestration (‚è≥ Integration pending)

---

## 9. Risks & Mitigation

| Risk | Impact | Probability | Mitigation Strategy |
|------|--------|-------------|---------------------|
| Cache corruption causing quality degradation | High | Low | Checksum validation, easy cache clearing |
| Cache taking excessive disk space | Medium | Medium | Document cache size, provide cleanup tools |
| Users confused about cache behavior | Low | Medium | Clear logging, documentation |
| Cache hit on wrong media (hash collision) | Critical | Very Low | Use SHA256 (collision probability negligible) |
| ASR model upgrade invalidates cache | Medium | High | Store model version in cache key |

---

## 10. Timeline & Milestones

| Phase | Duration | Deliverable | Status |
|-------|----------|-------------|--------|
| Week 1: Day 1-2 | 2-3 hours | Foundation (media_identity, cache_manager) | ‚úÖ Complete |
| Week 1: Day 3-4 | 2-4 hours | Workflow integration | ‚è≥ Next |
| Week 1: Day 5 | 1-2 hours | Performance validation | ‚è≥ Planned |
| Week 2: Full | 1-2 weeks | Advanced features (glossary learning, context cache) | ‚è≥ Planned |

**Current Status:** Week 1 Day 2 Complete (Foundation built)  
**Next Step:** Week 1 Day 3-4 (Workflow integration)

---

## 11. Related Documents

- **Technical Requirement:** [TRD-014](../trd/TRD-014.md)
- **Architecture Decision:** [AD-014](../../docs/ARCHITECTURE.md#ad-014)
- **Implementation:** [AD014_WEEK1_COMPLETE_SUMMARY.md](../../AD014_WEEK1_COMPLETE_SUMMARY.md)
- **Quick Reference:** [AD014_QUICK_REFERENCE.md](../../AD014_QUICK_REFERENCE.md)

---

## 12. Approval

| Role | Status | Date |
|------|--------|------|
| Business Owner | ‚úÖ Approved | 2025-12-08 |
| Tech Lead | ‚úÖ Approved | 2025-12-08 |
| QA Lead | ‚úÖ Approved | 2025-12-08 |

---

## 13. Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-08 | System Architect | Initial creation |
| 1.1 | 2025-12-08 | System | Week 1 Day 1-2 completion update |
