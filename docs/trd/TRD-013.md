# Technical Requirement Document

**Document ID:** TRD-013  
**Related BRD:** BRD-013  
**Title:** Organized Test Structure Implementation  
**Version:** 1.0  
**Date:** 2025-12-08  
**Status:** ⏳ Planned  
**Author:** System Architect

---

## 1. Technical Summary

Implement a comprehensive test organization system that categorizes all tests into unit, integration, functional, and manual categories within the `tests/` directory. This improves test discoverability, enables targeted test execution, and prevents project root clutter from ad-hoc test files.

**Related AD:** AD-013 (Organized Test Structure)

---

## 2. Related Business Requirements

**From BRD-013:**
- FR-001: All tests in `tests/` directory (never project root)
- FR-002: Four test categories: unit, integration, functional, manual
- FR-003: Consistent naming: `test_{feature}.py` or `test-{feature}.sh`
- FR-004: Pytest-compatible discovery patterns
- NFR-001: Clean project root (no loose test files)
- NFR-002: Easy test discovery and execution

---

## 3. Technical Architecture

### 3.1 Test Directory Structure

```
tests/
├─ unit/                           # Fast, isolated tests (no I/O, no GPU)
│  ├─ test_config_loader.py
│  ├─ test_media_identity.py
│  ├─ test_cache_manager.py
│  └─ test_stage_utils.py
│
├─ integration/                    # Multi-component tests (I/O, no GPU)
│  ├─ test_stage_integration.py
│  ├─ test_manifest_tracking.py
│  └─ test_pipeline_flow.py
│
├─ functional/                     # End-to-end workflow tests (full pipeline)
│  ├─ test_transcribe_workflow.py
│  ├─ test_translate_workflow.py
│  └─ test_subtitle_workflow.py
│
├─ manual/                         # Manual test scripts (exploration, debugging)
│  ├─ transcribe/
│  │  ├─ test-mlx-backend.sh
│  │  └─ test-whisperx-fallback.sh
│  ├─ translate/
│  │  └─ test-indictrans2.sh
│  ├─ subtitle/
│  │  └─ test-full-pipeline.sh
│  └─ cache/
│     └─ test-baseline-caching.sh
│
├─ fixtures/                       # Shared test data and fixtures
│  ├─ test-media/
│  │  ├─ sample-english.mp4 (symlink to in/Energy Demand in AI.mp4)
│  │  └─ sample-hinglish.mp4 (symlink to in/test_clips/jaane_tu_test_clip.mp4)
│  └─ expected-outputs/
│
├─ conftest.py                     # Pytest configuration and fixtures
└─ pytest.ini                      # Pytest settings
```

### 3.2 Test Category Definitions

| Category | Purpose | Execution Time | Dependencies |
|----------|---------|----------------|--------------|
| **Unit** | Test single functions/classes in isolation | <1 second each | None (mocked I/O) |
| **Integration** | Test interactions between components | 1-10 seconds | File I/O, config, no GPU |
| **Functional** | Test complete workflows end-to-end | 1-5 minutes | Full pipeline, GPU optional |
| **Manual** | Exploratory testing, debugging, experiments | Variable | Full environment |

---

## 4. Technical Requirements

### TR-001: Test Directory Organization
**Priority:** High  
**Related FR:** FR-001, FR-002  
**Description:** Organize all tests into appropriate categories  
**Implementation:** Move existing tests, create category directories

**Current Violations:**
```bash
# Project root test files to migrate:
test-*.sh                      # Manual test scripts
test_*.py                      # Ad-hoc Python tests
debug-*.py                     # Debug scripts
```

**Migration Mapping:**
```
Project Root → tests/manual/{workflow}/
test-transcribe-mlx.sh → tests/manual/transcribe/test-mlx-backend.sh
test-cache.py → tests/manual/cache/test-baseline-caching.sh
test_unit_feature.py → tests/unit/test_feature.py
```

**Acceptance Criteria:**
- [ ] All test categories created
- [ ] Existing tests categorized and moved
- [ ] No test files in project root
- [ ] .gitignore updated

**Status:** ⏳ Not Started

### TR-002: Pytest Configuration
**Priority:** High  
**Related FR:** FR-004  
**Description:** Configure pytest for test discovery and execution  
**Implementation:** `pytest.ini` and `conftest.py` setup

**pytest.ini:**
```ini
[pytest]
testpaths = tests/unit tests/integration tests/functional
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Markers for selective execution
markers =
    unit: Unit tests (fast, no I/O)
    integration: Integration tests (I/O, no GPU)
    functional: Functional tests (full pipeline)
    slow: Tests that take >30 seconds
    gpu: Tests that require GPU

# Test output
addopts = 
    --verbose
    --color=yes
    --tb=short
    -ra

# Coverage
[coverage:run]
source = scripts,shared
omit = tests/*,venv/*
```

**Acceptance Criteria:**
- [ ] pytest.ini configured
- [ ] Test markers defined
- [ ] Discovery patterns set
- [ ] Coverage reporting enabled

**Status:** ⏳ Not Started

### TR-003: Test Fixtures
**Priority:** Medium  
**Related FR:** FR-002  
**Description:** Shared test fixtures and test media  
**Implementation:** `tests/fixtures/` and `conftest.py`

**conftest.py:**
```python
import pytest
from pathlib import Path

@pytest.fixture
def test_media_english():
    """Standard English test media"""
    return Path("in/Energy Demand in AI.mp4")

@pytest.fixture
def test_media_hinglish():
    """Standard Hinglish test media"""
    return Path("in/test_clips/jaane_tu_test_clip.mp4")

@pytest.fixture
def temp_job_dir(tmp_path):
    """Temporary job directory for tests"""
    job_dir = tmp_path / "job-test-0001"
    job_dir.mkdir(parents=True)
    return job_dir

@pytest.fixture
def mock_config():
    """Mock configuration for unit tests"""
    return {
        "WHISPERX_MODEL": "large-v3",
        "DEVICE": "cpu",
        "COMPUTE_TYPE": "int8"
    }
```

**Acceptance Criteria:**
- [ ] Standard test media fixtures
- [ ] Temporary directory fixtures
- [ ] Mock configuration fixtures
- [ ] Documented in conftest.py

**Status:** ⏳ Not Started

### TR-004: Test Execution Commands
**Priority:** Medium  
**Description:** Standardized commands for running test categories  
**Implementation:** Makefile targets and documentation

**Makefile:**
```makefile
# Run all tests
test:
	pytest tests/

# Run by category
test-unit:
	pytest tests/unit/ -m unit

test-integration:
	pytest tests/integration/ -m integration

test-functional:
	pytest tests/functional/ -m functional

# Run with coverage
test-coverage:
	pytest --cov=scripts --cov=shared --cov-report=html

# Run fast tests only
test-fast:
	pytest -m "not slow"
```

**Acceptance Criteria:**
- [ ] Makefile targets defined
- [ ] Documentation in README.md
- [ ] Quick reference in DEVELOPER_STANDARDS.md

**Status:** ⏳ Not Started

---

## 5. Implementation Phases

### Phase 1: Structure Creation (⏳ Week 1)
- [ ] Create test category directories
- [ ] Configure pytest.ini
- [ ] Create conftest.py with fixtures
- [ ] Update .gitignore

### Phase 2: Migration (⏳ Week 1-2)
- [ ] Audit existing tests
- [ ] Categorize and move tests
- [ ] Remove project root test files
- [ ] Update test paths in documentation

### Phase 3: Enhancement (⏳ Week 2)
- [ ] Add Makefile test targets
- [ ] Create test execution documentation
- [ ] Add test fixtures for common scenarios
- [ ] Integrate with CI/CD

### Phase 4: Documentation (⏳ Week 2)
- [ ] Update DEVELOPER_STANDARDS.md
- [ ] Add to Copilot Instructions
- [ ] Create test writing guide
- [ ] Document test categories

---

## 6. Testing Strategy

### 6.1 Test Discovery Verification

```bash
# Verify pytest discovers all tests
pytest --collect-only
# Expected: All tests in tests/ discovered

# Verify no project root tests
ls -1 test*.py test*.sh 2>/dev/null | wc -l
# Expected: 0
```

### 6.2 Selective Test Execution

```bash
# Run only unit tests
pytest tests/unit/

# Run only integration tests
pytest tests/integration/

# Run tests matching pattern
pytest -k "test_cache"

# Run with specific marker
pytest -m "unit and not slow"
```

---

## 7. Test Writing Guidelines

### 7.1 Unit Test Example

```python
# tests/unit/test_media_identity.py

import pytest
from pathlib import Path
from shared.media_identity import compute_media_id

def test_compute_media_id_consistent(test_media_english):
    """Same file produces same media_id"""
    id1 = compute_media_id(test_media_english)
    id2 = compute_media_id(test_media_english)
    assert id1 == id2

def test_compute_media_id_different():
    """Different files produce different media_ids"""
    file1 = Path("in/file1.mp4")
    file2 = Path("in/file2.mp4")
    
    # Mock or use actual test files
    id1 = compute_media_id(file1)
    id2 = compute_media_id(file2)
    assert id1 != id2
```

### 7.2 Integration Test Example

```python
# tests/integration/test_cache_manager.py

import pytest
from shared.cache_manager import MediaCacheManager
from shared.media_identity import compute_media_id

def test_store_and_retrieve_baseline(test_media_english, tmp_path):
    """Baseline can be stored and retrieved"""
    
    # Setup
    manager = MediaCacheManager(cache_dir=tmp_path)
    media_id = compute_media_id(test_media_english)
    baseline = {"asr": "test data"}
    
    # Store
    manager.store_baseline(media_id, baseline)
    
    # Retrieve
    retrieved = manager.get_baseline(media_id)
    assert retrieved == baseline
```

### 7.3 Functional Test Example

```python
# tests/functional/test_transcribe_workflow.py

import pytest
from pathlib import Path
import subprocess

@pytest.mark.functional
@pytest.mark.slow
def test_transcribe_workflow_english(test_media_english, tmp_path):
    """Complete transcribe workflow on English media"""
    
    # Prepare job
    result = subprocess.run([
        "./prepare-job.sh",
        "--media", str(test_media_english),
        "--workflow", "transcribe"
    ], capture_output=True, text=True)
    
    assert result.returncode == 0
    
    # Run pipeline
    # ... (run and validate)
```

---

## 8. Related Architectural Decisions

**AD-013:** Organized Test Structure  
**Why:** Improve test discoverability and targeted execution

**Dependencies:**
- AD-012 (Log Management): Test logs go to logs/testing/

**Impact:**
- Cleaner project structure
- Better test organization
- Easier CI/CD integration
- Faster test iteration

---

## 9. Success Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Project root tests | 0 files | Unknown | ⏳ Not measured |
| Test categories | 4 complete | 0 | ⏳ Not started |
| Pytest discovery | 100% | Unknown | ⏳ Not started |
| Documentation | Complete | 0% | ⏳ Not started |
| Implementation time | 2-3 hours | N/A | ⏳ Not started |

---

## 10. Related Documents

- **BRD:** [BRD-013](../brd/BRD-013.md)
- **Architecture:** [AD-013 in ARCHITECTURE.md](../ARCHITECTURE.md)
- **Standards:** [DEVELOPER_STANDARDS.md](../developer/DEVELOPER_STANDARDS.md)

---

## 11. Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-08 | System Architect | Initial TRD creation |
