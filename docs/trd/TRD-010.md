# Technical Requirement Document

**Document ID:** TRD-010  
**Related BRD:** BRD-010  
**Title:** Workflow-Specific Output Format Implementation  
**Version:** 1.0  
**Date:** 2025-12-06  
**Status:** üîÑ In Progress (Partial Implementation)  
**Author:** System Architect

---

## 1. Technical Summary

Implement workflow-aware output generation that produces appropriate file formats based on workflow type: transcribe workflow generates text transcripts only, translate workflow generates translated transcripts only, and subtitle workflow generates full SRT/VTT subtitle tracks with soft embedding.

**Related AD:** AD-010 (Workflow-Specific Outputs)

---

## 2. Related Business Requirements

**From BRD-010:**
- FR-001: Transcribe workflow outputs .txt transcript in source language
- FR-002: Translate workflow outputs .txt transcript in target language
- FR-003: Subtitle workflow outputs SRT/VTT tracks + soft-embedded video
- NFR-001: 15-30% performance gain by skipping unnecessary stages
- NFR-002: Clear user expectations per workflow

---

## 3. Technical Architecture

### 3.1 Workflow Output Matrix

| Workflow | Stages | Output Format | Location |
|----------|--------|---------------|----------|
| **transcribe** | 01-07 | transcript.txt (source lang) | `07_alignment/` |
| **translate** | 01-07, 10 | transcript_{lang}.txt (target lang) | `10_translation/` |
| **subtitle** | 01-12 | .srt/.vtt + soft-embedded .mp4 | `12_mux/` |

### 3.2 Stage Execution Control

```python
def get_workflow_stages(workflow: str) -> List[str]:
    """Return stages to execute per workflow"""
    
    base_stages = [
        "01_demux",
        "02_tmdb",  # Only for subtitle
        "03_glossary_load",
        "04_source_separation",
        "05_pyannote_vad",
        "06_asr",
        "07_alignment"
    ]
    
    if workflow == "transcribe":
        return base_stages[:7]  # Stop at alignment
    
    elif workflow == "translate":
        return base_stages[:7] + ["10_translation"]
    
    elif workflow == "subtitle":
        return base_stages + [
            "08_lyrics_detection",
            "09_hallucination_removal",
            "10_translation",
            "11_subtitle_generation",
            "12_mux"
        ]
```

---

## 4. Technical Requirements

### TR-001: Workflow-Aware Stage Selection
**Priority:** High  
**Related FR:** FR-001, FR-002, FR-003, NFR-001  
**Description:** Pipeline only executes stages needed for workflow type  
**Implementation:** `run-pipeline.py` filters stages based on workflow

**Acceptance Criteria:**
- [ ] Transcribe workflow stops at Stage 07
- [ ] Translate workflow runs 01-07 + 10
- [ ] Subtitle workflow runs all 12 stages
- [ ] 15-30% time savings on transcribe/translate

**Status:** ‚è≥ Planned (Week 2)

### TR-002: Transcript Export Format
**Priority:** High  
**Related FR:** FR-001, FR-002  
**Description:** Plain text transcript with timestamps (optional)  
**Implementation:** Export function in Stage 07 and Stage 10

**Acceptance Criteria:**
- [ ] Plain text format: "[HH:MM:SS] Speaker: Text"
- [ ] UTF-8 encoding for all languages
- [ ] Native script for non-English (Devanagari for Hindi)
- [ ] Proper noun capitalization for English

**Status:** üîÑ Partial (Stage 07 exports, Stage 10 needs update)

### TR-003: Subtitle Export Format
**Priority:** High  
**Related FR:** FR-003  
**Description:** SRT/VTT format with proper timing and styling  
**Implementation:** Stage 11 generates subtitles, Stage 12 embeds

**Acceptance Criteria:**
- [x] SRT format support
- [x] VTT format support
- [x] Proper timing (word-level alignment)
- [x] Multi-language tracks

**Status:** ‚úÖ Complete (Already implemented)

### TR-004: TMDB Workflow Gate
**Priority:** Medium  
**Related FR:** NFR-001  
**Description:** Only enable TMDB stage for subtitle workflow  
**Implementation:** Skip Stage 02 for transcribe/translate workflows

**Acceptance Criteria:**
- [ ] TMDB skipped on transcribe workflow
- [ ] TMDB skipped on translate workflow
- [ ] TMDB runs on subtitle workflow (if enabled)

**Status:** üîÑ Partial (TMDB workflow-aware logic exists)

---

## 5. Implementation Approach

### 5.1 Pipeline Stage Filtering

**In `run-pipeline.py`:**
```python
# Read workflow from job.json
workflow = job_data.get("workflow", "subtitle")

# Get stages for workflow
stages = get_workflow_stages(workflow)

# Execute only relevant stages
for stage in stages:
    run_stage(stage, job_dir)
```

### 5.2 Output Location by Workflow

**Transcribe:**
```
out/{date}/{user}/{job}/
‚îî‚îÄ 07_alignment/
   ‚îî‚îÄ transcript.txt  # Source language
```

**Translate:**
```
out/{date}/{user}/{job}/
‚îî‚îÄ 10_translation/
   ‚îî‚îÄ transcript_en.txt  # Target language
```

**Subtitle:**
```
out/{date}/{user}/{job}/
‚îî‚îÄ 12_mux/
   ‚îú‚îÄ output.mp4  # Soft-embedded subtitles
   ‚îú‚îÄ subtitles_hi.srt
   ‚îú‚îÄ subtitles_en.srt
   ‚îî‚îÄ ...
```

---

## 6. Testing Strategy

### 6.1 Workflow Stage Tests

**Test transcribe workflow:**
```bash
./prepare-job.sh --media in/Energy\ Demand\ in\ AI.mp4 --workflow transcribe
# Expected: Stages 01-07 only, transcript.txt output
```

**Test translate workflow:**
```bash
./prepare-job.sh --media in/Energy\ Demand\ in\ AI.mp4 --workflow translate -s en -t hi
# Expected: Stages 01-07 + 10, transcript_hi.txt output
```

**Test subtitle workflow:**
```bash
./prepare-job.sh --media in/Jaane\ Tu\ Ya\ Jaane\ Na\ 2008.mp4 --workflow subtitle
# Expected: All 12 stages, soft-embedded video output
```

### 6.2 Performance Tests

- Measure transcribe workflow time (target: 30% faster than full pipeline)
- Measure translate workflow time (target: 20% faster than full pipeline)
- Verify quality not degraded by stage skipping

---

## 7. Related Architectural Decisions

**AD-010:** Workflow-Specific Outputs  
**Why:** Optimize performance by only running needed stages

**Dependencies:**
- AD-006 (Job Config): Read workflow from job.json

**Impact:**
- 15-30% performance improvement
- Clearer user expectations
- Simpler output structure

---

## 8. Success Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Stage filtering | Complete | Not implemented | ‚è≥ Planned |
| Transcript export | Complete | Partial | üîÑ In progress |
| Performance gain | 15-30% | Not measured | ‚è≥ Pending |
| User clarity | High | Medium | üîÑ Improving |

---

## 9. Related Documents

- **BRD:** [BRD-010](../brd/BRD-010.md)
- **Architecture:** [AD-010 in ARCHITECTURE.md](../ARCHITECTURE.md)
- **Workflows:** [Copilot Instructions ¬ß 1.5](../../.github/copilot-instructions.md)

---

## 10. Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-06 | System Architect | Initial TRD creation |
| 1.1 | 2025-12-08 | System | Implementation status update |
