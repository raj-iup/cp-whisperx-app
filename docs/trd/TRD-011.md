# Technical Requirement Document

**Document ID:** TRD-011  
**Related BRD:** BRD-011  
**Title:** Robust File Path Handling for Subprocess Operations  
**Version:** 1.0  
**Date:** 2025-12-08  
**Status:** üîÑ In Progress (Partial Implementation)  
**Author:** System Architect

---

## 1. Technical Summary

Implement comprehensive file path validation and handling patterns for subprocess operations (FFmpeg, external scripts) to prevent failures from special characters, encoding issues, missing files, or permission errors. This ensures 95%+ subprocess success rate through pre-flight validation.

**Related AD:** AD-011 (Robust File Path Handling)

---

## 2. Related Business Requirements

**From BRD-011:**
- FR-001: Pre-flight file validation before subprocess execution
- FR-002: Handle special characters in file paths correctly
- FR-003: Provide actionable error messages on failures
- NFR-001: 95%+ subprocess success rate
- NFR-002: Cross-platform compatibility (macOS, Linux, Windows)

---

## 3. Technical Architecture

### 3.1 Validation Pipeline

```
File Path Input
  ‚Üì
1. Path Resolution (convert to absolute)
  ‚Üì
2. Existence Check (file exists?)
  ‚Üì
3. Type Validation (is it a file, not directory?)
  ‚Üì
4. Size Check (non-zero size?)
  ‚Üì
5. Permission Check (readable?)
  ‚Üì
6. Special Char Handling (proper string conversion)
  ‚Üì
7. Subprocess Execution
  ‚Üì
8. Error Handling (parse stderr, provide solutions)
```

### 3.2 Error Categories

| Error | Cause | Detection | Solution |
|-------|-------|-----------|----------|
| FileNotFoundError | Missing file | `path.exists()` | Check path, provide suggestions |
| PermissionError | Access denied | `open(path, 'rb')` | Check permissions, suggest chmod |
| Special chars | Encoding issues | N/A (handle via str()) | Use `str(path)` in subprocess |
| Empty file | Zero size | `path.stat().st_size` | Validate before processing |
| Corruption | Invalid format | FFmpeg error 234 | Suggest re-encoding or different source |

---

## 4. Technical Requirements

### TR-001: Path Resolution and Validation
**Priority:** Critical  
**Related FR:** FR-001  
**Description:** Convert all paths to absolute and validate before use  
**Implementation:** Standardized validation function

**Implementation:**
```python
from pathlib import Path

def validate_input_file(file_path: Path, logger) -> bool:
    """Pre-flight validation for input files"""
    
    # 1. Convert to absolute path
    input_file = Path(file_path).resolve()
    
    # 2. Check existence
    if not input_file.exists():
        logger.error(f"‚ùå Input file not found: {input_file}")
        return False
    
    # 3. Validate type
    if not input_file.is_file():
        logger.error(f"‚ùå Not a file: {input_file}")
        return False
    
    # 4. Check size
    if input_file.stat().st_size == 0:
        logger.error(f"‚ùå File is empty: {input_file}")
        return False
    
    # 5. Test accessibility
    try:
        with open(input_file, 'rb') as f:
            f.read(1)
    except PermissionError:
        logger.error(f"‚ùå Permission denied: {input_file}")
        return False
    except Exception as e:
        logger.error(f"‚ùå Cannot read file: {e}")
        return False
    
    return True
```

**Acceptance Criteria:**
- [x] Documented in AD-011
- [ ] Implemented in all subprocess-using stages
- [ ] Unit tests for edge cases
- [ ] Integration tests with real files

**Status:** üîÑ Partial (Pattern documented, not fully applied)

### TR-002: Subprocess Command Building
**Priority:** High  
**Related FR:** FR-002  
**Description:** Proper string conversion for subprocess arguments  
**Implementation:** Always use `str(path)` for Path objects

**Pattern:**
```python
from pathlib import Path
import subprocess

# ‚úÖ CORRECT - Use str() for Path objects
input_file = Path("media/file with spaces.mp4").resolve()
output_file = Path("out/result.mp4").resolve()

cmd = ['ffmpeg', '-i', str(input_file), str(output_file)]
subprocess.run(cmd, capture_output=True, text=True, check=True)

# ‚ùå WRONG - Don't use Path objects directly
cmd = ['ffmpeg', '-i', input_file, output_file]  # May fail!
```

**Acceptance Criteria:**
- [ ] All FFmpeg calls use str(path)
- [ ] All external script calls use str(path)
- [ ] Cross-platform tested

**Status:** ‚è≥ Planned (Audit needed)

### TR-003: Enhanced Error Handling
**Priority:** High  
**Related FR:** FR-003  
**Description:** Parse subprocess errors and provide actionable messages  
**Implementation:** Error code mapping and stderr parsing

**Pattern:**
```python
try:
    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        check=True,
        timeout=300
    )
except subprocess.CalledProcessError as e:
    # Parse FFmpeg-specific errors
    if e.returncode == 234:
        logger.error("‚ùå FFmpeg error 234: Invalid input/output")
        logger.error("   Possible causes:")
        logger.error("   - Special characters in filename")
        logger.error("   - File corruption")
        logger.error("   - Unsupported format")
        logger.error(f"   Stderr: {e.stderr[:500]}")
    else:
        logger.error(f"‚ùå Subprocess failed (exit {e.returncode})")
        logger.error(f"   Command: {' '.join(cmd)}")
        logger.error(f"   Stderr: {e.stderr}")
    
    raise RuntimeError(f"Subprocess failed: {e}")
```

**Acceptance Criteria:**
- [ ] FFmpeg error codes mapped
- [ ] Actionable error messages
- [ ] Stderr parsing implemented
- [ ] Common errors documented

**Status:** üîÑ Partial (Basic error handling exists)

### TR-004: Cross-Platform Compatibility
**Priority:** Medium  
**Related FR:** NFR-002  
**Description:** Ensure path handling works on all platforms  
**Implementation:** Use pathlib, avoid hardcoded separators

**Rules:**
```python
# ‚úÖ CORRECT - Cross-platform
from pathlib import Path
path = Path("dir") / "subdir" / "file.txt"

# ‚ùå WRONG - Unix-only
path = "dir/subdir/file.txt"

# ‚ùå WRONG - Windows-only
path = "dir\\subdir\\file.txt"
```

**Acceptance Criteria:**
- [ ] All paths use pathlib
- [ ] No hardcoded path separators
- [ ] Windows testing completed

**Status:** üîÑ Partial (Most code uses pathlib)

---

## 5. Implementation Phases

### Phase 1: Core Validation (üîÑ In Progress)
- [x] Document validation pattern
- [ ] Create shared validation function
- [ ] Apply to FFmpeg operations
- [ ] Apply to external scripts

### Phase 2: Error Enhancement (‚è≥ Planned)
- [ ] Map FFmpeg error codes
- [ ] Parse stderr for common issues
- [ ] Provide actionable solutions
- [ ] Update error messages

### Phase 3: Testing (‚è≥ Planned)
- [ ] Unit tests for validation
- [ ] Integration tests with edge cases
- [ ] Cross-platform testing
- [ ] Performance impact measurement

---

## 6. Testing Strategy

### 6.1 Edge Cases

**Test Files:**
- `file with spaces.mp4`
- `file-with-unicode-Â≠óÂπï.mp4`
- `empty-file.mp4` (0 bytes)
- `corrupted.mp4` (invalid format)
- `no-permission.mp4` (chmod 000)

**Expected Behavior:**
- Spaces: ‚úÖ Handled via str()
- Unicode: ‚úÖ Handled via UTF-8 encoding
- Empty: ‚ùå Caught in pre-flight validation
- Corrupted: ‚ùå Caught with actionable FFmpeg error
- No permission: ‚ùå Caught in accessibility check

### 6.2 Integration Tests

```python
def test_validate_input_file():
    """Test pre-flight validation"""
    
    # Valid file
    assert validate_input_file(Path("in/test.mp4"), logger) == True
    
    # Missing file
    assert validate_input_file(Path("nonexistent.mp4"), logger) == False
    
    # Empty file
    Path("empty.mp4").touch()
    assert validate_input_file(Path("empty.mp4"), logger) == False
    
    # Directory (not file)
    assert validate_input_file(Path("in/"), logger) == False
```

---

## 7. Related Architectural Decisions

**AD-011:** Robust File Path Handling  
**Why:** Prevent subprocess failures from path issues

**Dependencies:**
- AD-001 (12-Stage Architecture): Apply to all stages using subprocess
- AD-005 (MLX Backend): FFmpeg demux operations

**Impact:**
- 95%+ subprocess success rate target
- Better error messages
- Reduced debugging time

---

## 8. Success Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Subprocess success rate | >95% | Unknown | ‚è≥ Not measured |
| Pre-flight validation | 100% coverage | ~30% | üîÑ In progress |
| Error message quality | High | Medium | üîÑ Improving |
| Cross-platform tests | Complete | Partial | ‚è≥ Pending |

---

## 9. Related Documents

- **BRD:** [BRD-011](../brd/BRD-011.md)
- **Architecture:** [AD-011 in ARCHITECTURE.md](../ARCHITECTURE.md)
- **Standards:** [DEVELOPER_STANDARDS.md](../developer/DEVELOPER_STANDARDS.md)

---

## 10. Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-08 | System Architect | Initial TRD creation |
