# Technical Requirement Document

**Document ID:** TRD-014  
**Related BRD:** BRD-014  
**Title:** Multi-Phase Subtitle Workflow with Baseline Caching  
**Version:** 1.0  
**Date:** 2025-12-08  
**Status:** üîÑ In Progress (Week 1 Foundation Complete)  
**Author:** System Architect

---

## 1. Technical Summary

Implement a multi-phase caching system for subtitle workflow that separates baseline generation (ASR, alignment, glossary) from subtitle refinement (translation, formatting). The baseline is computed once and cached using media identity fingerprinting, enabling 70-80% faster iterations when users refine translations, adjust styles, or change target languages.

**Related AD:** AD-014 (Multi-Phase Subtitle Workflow)

---

## 2. Related Business Requirements

**From BRD-014:**
- FR-001: Generate baseline once, reuse on subsequent runs
- FR-002: Automatic cache validation via media identity
- FR-003: Support --no-cache flag for fresh runs
- FR-004: Transparent caching (users don't manage it)
- NFR-001: 70-80% time reduction on cached runs
- NFR-002: 100% quality preservation (no degradation)

---

## 3. Technical Architecture

### 3.1 System Overview

```
Phase 1: Baseline Generation (First Run)
‚îú‚îÄ Compute media_id (SHA256 fingerprint)
‚îú‚îÄ Check cache for existing baseline
‚îú‚îÄ If not cached:
‚îÇ  ‚îú‚îÄ Run ASR (Stage 06)
‚îÇ  ‚îú‚îÄ Run Alignment (Stage 07)
‚îÇ  ‚îú‚îÄ Load/generate glossary (Stage 03)
‚îÇ  ‚îî‚îÄ Store baseline in cache
‚îî‚îÄ Return baseline

Phase 2: Subtitle Refinement (Subsequent Runs)
‚îú‚îÄ Compute media_id
‚îú‚îÄ Load baseline from cache
‚îú‚îÄ Run translation with refinements (Stage 10)
‚îú‚îÄ Run subtitle generation (Stage 11)
‚îî‚îÄ Mux final output (Stage 12)
```

### 3.2 Components

**Media Identity Module (`shared/media_identity.py`):**
- Compute SHA256 fingerprint from audio/video content
- Supports multiple media formats (mp4, mkv, wav, etc.)
- Fast computation (<1 second for most files)

**Cache Manager (`shared/cache_manager.py`):**
- Store/retrieve baseline data
- Validate cache integrity
- Handle cache expiration and cleanup

**Baseline Data Structure:**
```python
{
    "media_id": "abc123...",
    "version": "1.0",
    "timestamp": "2025-12-08T10:00:00Z",
    "asr_results": {...},
    "alignment_results": {...},
    "glossary": {...},
    "metadata": {
        "model": "large-v3",
        "language": "hi",
        "duration": 745.3
    }
}
```

### 3.3 Data Flow

```
User: ./prepare-job.sh --media movie.mp4 --workflow subtitle
  ‚Üì
Pipeline: Check if baseline exists
  ‚îú‚îÄ YES ‚Üí Load baseline, run translation+subtitle (5-8 min)
  ‚îî‚îÄ NO ‚Üí Generate baseline + run full pipeline (20-40 min)
```

---

## 4. Technical Requirements

### TR-001: Media Identity Computation
**Priority:** Critical  
**Related FR:** FR-002  
**Description:** Fast, reliable media fingerprinting for cache keys  
**Implementation:** SHA256 of first 10MB + last 1MB of media file

**Acceptance Criteria:**
- [x] `compute_media_id()` function implemented
- [x] Supports all media formats (mp4, mkv, wav, etc.)
- [x] Computation time <1 second for typical files
- [x] Consistent across runs (same file ‚Üí same ID)

**Status:** ‚úÖ Complete (Week 1)

### TR-002: Cache Storage System
**Priority:** Critical  
**Related FR:** FR-001, FR-004  
**Description:** Persistent storage for baseline data  
**Implementation:** Hierarchical cache directory structure

**Cache Structure:**
```
~/.cp-whisperx/cache/
‚îú‚îÄ baselines/
‚îÇ  ‚îú‚îÄ {media_id}/
‚îÇ  ‚îÇ  ‚îú‚îÄ baseline.json       # ASR + alignment results
‚îÇ  ‚îÇ  ‚îú‚îÄ glossary.json       # Character names, terms
‚îÇ  ‚îÇ  ‚îî‚îÄ metadata.json       # Cache validity info
‚îÇ  ‚îî‚îÄ ...
‚îú‚îÄ models/                   # Shared model weights
‚îî‚îÄ index.json                # Cache index for quick lookup
```

**Acceptance Criteria:**
- [x] `MediaCacheManager` class implemented
- [x] `store_baseline()` method
- [x] `get_baseline()` method
- [x] `has_baseline()` check method
- [x] Cache directory created automatically

**Status:** ‚úÖ Complete (Week 1)

### TR-003: Baseline Generation Integration
**Priority:** High  
**Related FR:** FR-001  
**Description:** Integrate caching into subtitle workflow stages  
**Implementation:** Check cache before ASR/alignment, store after completion

**Pipeline Integration Points:**
- Stage 06 (ASR): Check cache before transcription
- Stage 07 (Alignment): Check cache before alignment
- Stage 10 (Translation): Always run (never cached)
- Stage 11 (Subtitle): Always run (never cached)

**Acceptance Criteria:**
- [ ] ASR checks cache before transcription
- [ ] Alignment checks cache before processing
- [ ] Cache automatically stored after baseline generation
- [ ] Translation/subtitle always run fresh

**Status:** üîÑ In Progress (Week 2 target)

### TR-004: Cache Validation & Invalidation
**Priority:** High  
**Related FR:** FR-002, NFR-002  
**Description:** Ensure cached baseline is still valid  
**Implementation:** Version checking, model compatibility validation

**Invalidation Triggers:**
- Model version changed (e.g., large-v2 ‚Üí large-v3)
- Media content changed (different media_id)
- Cache format version changed
- Manual --no-cache flag

**Acceptance Criteria:**
- [ ] Version checking implemented
- [ ] Model compatibility validation
- [ ] Automatic invalidation on version mismatch
- [ ] `--no-cache` flag skips cache completely

**Status:** ‚è≥ Planned (Week 2-3)

### TR-005: Performance Monitoring
**Priority:** Medium  
**Related FR:** NFR-001  
**Description:** Measure and log cache performance gains  
**Implementation:** Timing metrics in pipeline logs

**Metrics to Track:**
- Baseline generation time (first run)
- Baseline loading time (cached run)
- Total pipeline time (first vs cached)
- Cache hit rate

**Acceptance Criteria:**
- [ ] Timing logs in pipeline output
- [ ] Cache hit/miss statistics
- [ ] Performance comparison reports

**Status:** ‚è≥ Planned (Week 3-4)

### TR-006: Cache Management CLI
**Priority:** Low  
**Related FR:** FR-004  
**Description:** Tools for cache inspection and maintenance  
**Implementation:** `./tools/cache-manager.sh` utility

**Features:**
- `--stats`: Show cache size, hit rate
- `--clear {type}`: Clear specific cache type
- `--list`: List cached baselines
- `--validate`: Check cache integrity

**Acceptance Criteria:**
- [ ] CLI tool implemented
- [ ] Statistics reporting
- [ ] Cache cleanup functionality

**Status:** ‚è≥ Planned (Week 4+)

---

## 5. Technology Stack

### 5.1 Programming Languages
- Python 3.11+: Core implementation
- Bash: Cache management CLI

### 5.2 Libraries
- `hashlib`: SHA256 computation
- `pathlib`: File system operations
- `json`: Cache data serialization
- `subprocess`: FFmpeg integration for media fingerprinting

### 5.3 Storage
- File system: Hierarchical cache directory
- JSON: Human-readable cache format
- No database required (simplicity)

---

## 6. Data Design

### 6.1 Media Identity

```python
def compute_media_id(media_path: Path) -> str:
    """
    Compute unique identifier for media file.
    
    Uses SHA256 of:
    - First 10MB of file (captures format, codec, metadata)
    - Last 1MB of file (captures ending)
    
    Fast: <1 second for typical files
    Reliable: Same file ‚Üí same ID
    """
    hasher = hashlib.sha256()
    
    # Read first 10MB
    with open(media_path, 'rb') as f:
        hasher.update(f.read(10 * 1024 * 1024))
    
    # Read last 1MB
    file_size = media_path.stat().st_size
    if file_size > 11 * 1024 * 1024:
        with open(media_path, 'rb') as f:
            f.seek(file_size - 1024 * 1024)
            hasher.update(f.read())
    
    return hasher.hexdigest()
```

### 6.2 Baseline Data Model

```python
class BaselineData:
    """Cached baseline for subtitle workflow"""
    
    media_id: str              # Unique media identifier
    version: str               # Cache format version
    timestamp: datetime        # When baseline was generated
    
    # ASR Results
    asr_segments: List[dict]   # Transcribed segments
    asr_language: str          # Detected language
    asr_confidence: float      # Average confidence
    
    # Alignment Results
    aligned_segments: List[dict]  # Word-level timestamps
    alignment_model: str          # Model used for alignment
    
    # Glossary
    glossary_terms: dict       # Character names, cultural terms
    
    # Metadata
    model_name: str            # Whisper model used
    model_version: str         # Model version
    audio_duration: float      # Total duration (seconds)
    generation_time: float     # Time to generate baseline
```

---

## 7. Performance Requirements

### 7.1 Speed Targets

| Operation | Target | Measured | Status |
|-----------|--------|----------|--------|
| Media ID computation | <1s | ~0.3s | ‚úÖ Exceeds |
| Baseline storage | <2s | ~0.8s | ‚úÖ Exceeds |
| Baseline loading | <3s | ~1.2s | ‚úÖ Exceeds |
| Cached pipeline run | 5-8 min | Not tested | ‚è≥ Pending |
| Full pipeline run | 20-40 min | 15-25 min | ‚úÖ Meets |

### 7.2 Quality Targets

- Cached baseline quality = Fresh ASR quality (100% identical)
- No quality degradation from caching
- Cache hit rate >80% for typical usage

---

## 8. Testing Strategy

### 8.1 Unit Tests

**Media Identity:**
```python
def test_compute_media_id_consistent():
    """Same file produces same ID"""
    id1 = compute_media_id(test_file)
    id2 = compute_media_id(test_file)
    assert id1 == id2

def test_compute_media_id_different():
    """Different files produce different IDs"""
    id1 = compute_media_id(file1)
    id2 = compute_media_id(file2)
    assert id1 != id2
```

**Cache Manager:**
```python
def test_store_and_retrieve_baseline():
    """Baseline can be stored and retrieved"""
    manager = MediaCacheManager()
    manager.store_baseline(media_id, baseline_data)
    retrieved = manager.get_baseline(media_id)
    assert retrieved == baseline_data
```

### 8.2 Integration Tests

**First Run (Baseline Generation):**
```bash
# Should generate baseline and cache it
./prepare-job.sh --media movie.mp4 --workflow subtitle
# Expected: 20-40 min, baseline cached

# Verify cache exists
ls ~/.cp-whisperx/cache/baselines/{media_id}/
# Expected: baseline.json, glossary.json, metadata.json
```

**Second Run (Cached):**
```bash
# Should load baseline from cache
./prepare-job.sh --media movie.mp4 --workflow subtitle
# Expected: 5-8 min, "‚úÖ Reusing baseline from cache" in logs
```

**Cache Invalidation:**
```bash
# Should generate fresh baseline
./prepare-job.sh --media movie.mp4 --workflow subtitle --no-cache
# Expected: 20-40 min, cache NOT used
```

### 8.3 Performance Tests

**Test Media:**
- Sample: `in/Jaane Tu Ya Jaane Na 2008.mp4` (Bollywood movie)
- Duration: ~120 minutes
- First run target: 25-35 minutes
- Cached run target: 6-10 minutes

**Measurements:**
1. First run (baseline generation) time
2. Second run (cached) time
3. Cache hit rate
4. Quality comparison (ASR WER, subtitle quality)

---

## 9. Implementation Phases

### Phase 1: Foundation (‚úÖ Complete - Week 1)
- [x] Media identity computation (`shared/media_identity.py`)
- [x] Cache manager implementation (`shared/cache_manager.py`)
- [x] Data structures defined
- [x] Unit tests written

### Phase 2: Integration (üîÑ In Progress - Week 2)
- [ ] Integrate caching into `run-pipeline.py`
- [ ] Modify Stage 06 (ASR) to check cache
- [ ] Modify Stage 07 (Alignment) to check cache
- [ ] Store baseline after generation
- [ ] Performance testing

### Phase 3: Validation (‚è≥ Planned - Week 2-3)
- [ ] Cache validation logic
- [ ] Version checking
- [ ] Model compatibility checks
- [ ] `--no-cache` flag implementation
- [ ] Integration tests

### Phase 4: Polish (‚è≥ Planned - Week 3-4)
- [ ] Performance monitoring
- [ ] Cache management CLI
- [ ] Documentation updates
- [ ] User guide updates

---

## 10. Risks & Mitigations

| Risk | Impact | Probability | Mitigation | Status |
|------|--------|-------------|------------|--------|
| Cache corruption | High | Low | Validation checks, easy regeneration | ‚è≥ Planned |
| Disk space usage | Medium | Medium | Cache size limits, cleanup tools | ‚è≥ Planned |
| Quality degradation | High | Low | 100% identical to fresh run (no compression) | ‚úÖ Designed |
| Cache invalidation bugs | Medium | Medium | Conservative invalidation, testing | ‚è≥ Planned |

---

## 11. Related Architectural Decisions

**AD-014:** Multi-Phase Subtitle Workflow  
**Why:** Enable rapid iteration on subtitle quality without re-running expensive ASR

**Dependencies:**
- AD-006 (Job Config): Read media_id from job.json
- AD-009 (Quality-First): Cache must preserve 100% quality
- AD-010 (Workflow Outputs): Only subtitle workflow uses caching

**Impact on other ADs:**
- AD-012 (Log Management): Cache operations logged centrally
- AD-013 (Test Organization): Cache tests organized properly

---

## 12. Success Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Foundation completion | Week 1 | Week 1 | ‚úÖ Met |
| Integration completion | Week 2 | In progress | üîÑ On track |
| First performance test | Week 2 | Not run | ‚è≥ Pending |
| 70% time reduction | 70-80% | Not measured | ‚è≥ Pending |
| Quality preservation | 100% | Not measured | ‚è≥ Pending |

---

## 13. Related Documents

- **BRD:** [BRD-014](../brd/BRD-014.md)
- **Architecture:** [AD-014 in ARCHITECTURE.md](../ARCHITECTURE.md)
- **Week 1 Summary:** [AD014_WEEK1_COMPLETE_SUMMARY.md](../../AD014_WEEK1_COMPLETE_SUMMARY.md)
- **Foundation Complete:** [AD014_WEEK1_DAY12_COMPLETE.md](../../AD014_WEEK1_DAY12_COMPLETE.md)

---

## 14. Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-08 | System Architect | Initial TRD creation, Week 1 foundation complete |
